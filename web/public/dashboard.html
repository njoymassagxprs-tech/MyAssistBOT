<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyAssistBOT â€” Dashboard</title>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --card: #22263a;
      --border: #2d3250;
      --accent: #6c63ff;
      --accent-light: #8b82ff;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --cyan: #06b6d4;
      --text: #e2e8f0;
      --text-dim: #94a3b8;
      --text-muted: #64748b;
      --radius: 12px;
      --shadow: 0 4px 24px rgba(0,0,0,.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      background: linear-gradient(135deg, var(--surface) 0%, #1e2235 100%);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo { font-size: 24px; }
    .header h1 { font-size: 18px; font-weight: 600; }
    .header h1 span { color: var(--accent-light); }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .status-badge {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 14px; border-radius: 20px;
      font-size: 12px; font-weight: 600;
      background: rgba(34,197,94,.12); color: var(--green);
    }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; } 50% { opacity: .4; }
    }
    .refresh-btn {
      background: var(--card); border: 1px solid var(--border);
      color: var(--text-dim); padding: 6px 14px; border-radius: 8px;
      cursor: pointer; font-size: 12px; transition: .2s;
    }
    .refresh-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* â”€â”€ GRID â”€â”€ */
    .dashboard { padding: 24px 32px; max-width: 1440px; margin: 0 auto; }
    .grid { display: grid; gap: 20px; margin-bottom: 20px; }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 1100px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-3 { grid-template-columns: 1fr; }
      .grid-2 { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .grid-4 { grid-template-columns: 1fr; }
      .dashboard { padding: 12px; }
    }

    /* â”€â”€ CARDS â”€â”€ */
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow); transition: transform .2s, box-shadow .2s;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,.4); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .card-title { font-size: 13px; font-weight: 500; color: var(--text-dim); text-transform: uppercase; letter-spacing: .5px; }
    .card-icon { font-size: 20px; }

    /* â”€â”€ STAT CARDS â”€â”€ */
    .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
    .stat-sub { font-size: 12px; color: var(--text-muted); }
    .stat-change { font-size: 12px; display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 10px; margin-top: 6px; }
    .stat-change.up { background: rgba(34,197,94,.12); color: var(--green); }
    .stat-change.down { background: rgba(239,68,68,.12); color: var(--red); }

    /* â”€â”€ AGENT CARDS â”€â”€ */
    .agents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .agent-item {
      display: flex; align-items: center; gap: 10px;
      padding: 12px; border-radius: 10px;
      background: var(--surface); border: 1px solid var(--border);
      transition: .2s;
    }
    .agent-item:hover { border-color: var(--accent); }
    .agent-icon { font-size: 22px; flex-shrink: 0; }
    .agent-name { font-size: 13px; font-weight: 600; }
    .agent-desc { font-size: 11px; color: var(--text-muted); }
    .agent-badge {
      margin-left: auto; padding: 2px 8px;
      border-radius: 10px; font-size: 10px; font-weight: 600;
      background: rgba(108,99,255,.15); color: var(--accent-light);
    }

    /* â”€â”€ LOG TABLE â”€â”€ */
    .log-container { max-height: 360px; overflow-y: auto; }
    .log-container::-webkit-scrollbar { width: 6px; }
    .log-container::-webkit-scrollbar-track { background: transparent; }
    .log-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .log-entry {
      display: grid; grid-template-columns: 130px 90px 1fr auto;
      gap: 12px; padding: 10px 12px; border-radius: 8px;
      font-size: 12px; align-items: center;
      transition: background .15s;
    }
    .log-entry:nth-child(even) { background: rgba(255,255,255,.02); }
    .log-entry:hover { background: rgba(108,99,255,.06); }
    .log-time { color: var(--text-muted); font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 11px; }
    .log-action {
      padding: 2px 8px; border-radius: 6px; font-weight: 600; font-size: 11px;
      text-align: center; white-space: nowrap;
    }
    .log-action.prompt-received { background: rgba(6,182,212,.12); color: var(--cyan); }
    .log-action.response-sent { background: rgba(34,197,94,.12); color: var(--green); }
    .log-action.intent-parsed { background: rgba(108,99,255,.12); color: var(--accent-light); }
    .log-action.error { background: rgba(239,68,68,.12); color: var(--red); }
    .log-action.chain-started { background: rgba(234,179,8,.12); color: var(--yellow); }
    .log-action.chain-completed { background: rgba(234,179,8,.12); color: var(--yellow); }
    .log-details { color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .log-user { color: var(--text-dim); font-size: 11px; text-align: right; }

    /* â”€â”€ CHART â”€â”€ */
    .chart-container { position: relative; height: 200px; }
    canvas { width: 100% !important; }

    /* â”€â”€ INTENT BARS â”€â”€ */
    .intent-bar { margin-bottom: 8px; }
    .intent-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .intent-label span:first-child { color: var(--text); }
    .intent-label span:last-child { color: var(--text-muted); }
    .intent-track { height: 6px; background: var(--surface); border-radius: 3px; overflow: hidden; }
    .intent-fill { height: 100%; border-radius: 3px; transition: width .8s ease; }
    .intent-fill.c1 { background: linear-gradient(90deg, #6c63ff, #8b82ff); }
    .intent-fill.c2 { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
    .intent-fill.c3 { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .intent-fill.c4 { background: linear-gradient(90deg, #eab308, #facc15); }
    .intent-fill.c5 { background: linear-gradient(90deg, #ef4444, #f87171); }
    .intent-fill.c6 { background: linear-gradient(90deg, #a855f7, #c084fc); }
    .intent-fill.c7 { background: linear-gradient(90deg, #f97316, #fb923c); }

    /* â”€â”€ FOOTER â”€â”€ */
    .footer { text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px; }
    .footer a { color: var(--accent-light); text-decoration: none; }

    /* â”€â”€ Animations â”€â”€ */
    .fade-in { animation: fadeIn .4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
    .live-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--green); margin-right: 6px; animation: pulse 1.5s infinite; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="logo">ğŸ¤–</div>
      <h1>MyAssist <span>SystemBOT</span> â€” Dashboard</h1>
    </div>
    <div class="header-right">
      <div class="status-badge">
        <div class="status-dot"></div>
        <span id="statusText">Online</span>
      </div>
      <button class="refresh-btn" onclick="refreshAll()">â†» Atualizar</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard">

    <!-- STATS ROW -->
    <div class="grid grid-4 fade-in">
      <div class="card">
        <div class="card-header"><span class="card-title">AÃ§Ãµes Totais</span><span class="card-icon">ğŸ“Š</span></div>
        <div class="stat-value" id="totalActions">â€”</div>
        <div class="stat-sub" id="last24h">Ãšltimas 24h: â€”</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Uptime</span><span class="card-icon">â±ï¸</span></div>
        <div class="stat-value" id="uptime">â€”</div>
        <div class="stat-sub" id="uptimeDetail">Servidor API</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">IA Provider</span><span class="card-icon">ğŸ§ </span></div>
        <div class="stat-value" id="aiStatus" style="font-size:18px">â€”</div>
        <div class="stat-sub" id="aiModel">â€”</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Clientes WS</span><span class="card-icon">ğŸ”Œ</span></div>
        <div class="stat-value" id="wsClients">â€”</div>
        <div class="stat-sub" id="wsConversations">Conversas: â€”</div>
      </div>
    </div>

    <!-- AGENTS + INTENTS -->
    <div class="grid grid-2 fade-in" style="animation-delay:.1s">
      <!-- Agents -->
      <div class="card">
        <div class="card-header"><span class="card-title">Agentes Ativos</span><span class="card-icon">ğŸ¤–</span></div>
        <div class="agents-grid" id="agentsGrid">
          <!-- Populated by JS -->
        </div>
      </div>
      <!-- Top Intents -->
      <div class="card">
        <div class="card-header"><span class="card-title">Top IntenÃ§Ãµes</span><span class="card-icon">ğŸ¯</span></div>
        <div id="intentBars">
          <div style="color:var(--text-muted);font-size:13px;padding:20px 0;text-align:center;">A carregar...</div>
        </div>
      </div>
    </div>

    <!-- ACTIVITY CHART + MEMORY -->
    <div class="grid grid-3 fade-in" style="animation-delay:.2s">
      <div class="card" style="grid-column: span 2;">
        <div class="card-header"><span class="card-title"><span class="live-dot"></span>Atividade em Tempo Real</span><span class="card-icon">ğŸ“ˆ</span></div>
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">MemÃ³ria</span><span class="card-icon">ğŸ’¾</span></div>
        <div style="display:flex;flex-direction:column;gap:14px;margin-top:8px;">
          <div>
            <div class="intent-label"><span>Heap Used</span><span id="heapUsed">â€”</span></div>
            <div class="intent-track"><div class="intent-fill c1" id="heapBar" style="width:0%"></div></div>
          </div>
          <div>
            <div class="intent-label"><span>Heap Total</span><span id="heapTotal">â€”</span></div>
            <div class="intent-track"><div class="intent-fill c2" id="heapTotalBar" style="width:0%"></div></div>
          </div>
          <div>
            <div class="intent-label"><span>RSS</span><span id="rss">â€”</span></div>
            <div class="intent-track"><div class="intent-fill c3" id="rssBar" style="width:0%"></div></div>
          </div>
          <div>
            <div class="intent-label"><span>External</span><span id="external">â€”</span></div>
            <div class="intent-track"><div class="intent-fill c6" id="externalBar" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIVITY LOG -->
    <div class="card fade-in" style="animation-delay:.3s">
      <div class="card-header"><span class="card-title"><span class="live-dot"></span>Log de Atividade</span><span class="card-icon">ğŸ“‹</span></div>
      <div class="log-container" id="logContainer">
        <div style="color:var(--text-muted);font-size:13px;padding:20px 0;text-align:center;">A carregar logs...</div>
      </div>
    </div>

  </div>

  <!-- FOOTER -->
  <div class="footer">
    MyAssistBOT v2.0.0 â€” <a href="https://github.com/NjoY-MassagXprs/MyAssist_SystemBOT" target="_blank">GitHub</a>
  </div>

  <!-- Chart.js via CDN (lightweight) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIG
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const API_BASE = ''; // Servidor unificado â€” mesma origem
    const REFRESH_INTERVAL = 10000; // 10s

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AGENTS â€” Static definitions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const AGENTS = [
      { icon: 'ğŸ§ ', name: 'AI Agent',       desc: 'Chat & GeraÃ§Ã£o' },
      { icon: 'ğŸ“„', name: 'PDF Agent',       desc: 'Cria PDFs'     },
      { icon: 'ğŸ“', name: 'File Agent',      desc: 'GestÃ£o Ficheiros' },
      { icon: 'ğŸ’»', name: 'Code Runner',     desc: 'Executa cÃ³digo' },
      { icon: 'ğŸ”', name: 'Web Search',      desc: 'Pesquisa web'  },
      { icon: 'ğŸ–¥ï¸', name: 'System Agent',   desc: 'Controlo SO'   },
      { icon: 'âŒ¨ï¸', name: 'Input Agent',    desc: 'Teclado/Rato'  },
      { icon: 'ğŸ—ï¸', name: 'Project Builder', desc: 'Scaffold projetos' },
      { icon: 'ğŸŒ', name: 'Remote Agent',    desc: 'SSH remoto'    },
      { icon: 'ğŸ”—', name: 'Agent Chaining',  desc: 'Multi-passo'   },
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let activityChart = null;
    const chartData = { labels: [], data: [] };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('DOMContentLoaded', () => {
      renderAgents();
      initChart();
      refreshAll();
      setInterval(refreshAll, REFRESH_INTERVAL);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER AGENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderAgents() {
      const grid = document.getElementById('agentsGrid');
      grid.innerHTML = AGENTS.map(a => `
        <div class="agent-item">
          <div class="agent-icon">${a.icon}</div>
          <div>
            <div class="agent-name">${a.name}</div>
            <div class="agent-desc">${a.desc}</div>
          </div>
          <div class="agent-badge">ON</div>
        </div>
      `).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CHART
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initChart() {
      const ctx = document.getElementById('activityChart').getContext('2d');
      activityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'AÃ§Ãµes / 10s',
            data: [],
            borderColor: '#6c63ff',
            backgroundColor: 'rgba(108,99,255,.08)',
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointBackgroundColor: '#6c63ff',
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,.04)' },
              ticks: { color: '#64748b', font: { size: 10 }, maxTicksLimit: 10 }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255,255,255,.04)' },
              ticks: { color: '#64748b', font: { size: 10 }, stepSize: 1 }
            }
          },
          interaction: { intersect: false, mode: 'index' },
          animation: { duration: 400 }
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REFRESH ALL DATA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function refreshAll() {
      try {
        const [status, stats, logs] = await Promise.all([
          fetchJSON('/api/status'),
          fetchJSON('/api/dashboard/stats'),
          fetchJSON('/api/dashboard/logs'),
        ]);

        updateStatus(status);
        updateStats(stats);
        updateLogs(logs);
        updateChart(stats);
      } catch (err) {
        console.warn('Dashboard refresh failed:', err);
        document.getElementById('statusText').textContent = 'Offline';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UPDATE FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateStatus(s) {
      if (!s) return;
      document.getElementById('statusText').textContent = s.online ? 'Online' : 'Offline';
      document.getElementById('uptime').textContent = fmtUptime(s.uptime || 0);
      document.getElementById('wsClients').textContent = s.clients ?? 'â€”';
      document.getElementById('wsConversations').textContent = `Conversas: ${s.conversations ?? 'â€”'}`;

      // AI
      if (s.ai) {
        document.getElementById('aiStatus').textContent = s.ai.available ? 'âœ… Groq Online' : 'âŒ Offline';
        document.getElementById('aiModel').textContent = s.ai.model || 'â€”';
      }

      // Memory
      if (s.memory) {
        const m = s.memory;
        const maxMB = 512; // reference ceiling
        setMem('heapUsed', 'heapBar', m.heapUsed, maxMB);
        setMem('heapTotal', 'heapTotalBar', m.heapTotal, maxMB);
        setMem('rss', 'rssBar', m.rss, maxMB);
        setMem('external', 'externalBar', m.external, maxMB);
      }
    }

    function setMem(labelId, barId, bytes, maxMB) {
      const mb = (bytes / 1024 / 1024).toFixed(1);
      document.getElementById(labelId).textContent = `${mb} MB`;
      document.getElementById(barId).style.width = Math.min(100, (mb / maxMB) * 100) + '%';
    }

    function updateStats(s) {
      if (!s) return;
      document.getElementById('totalActions').textContent = s.totalActions ?? 0;
      document.getElementById('last24h').textContent = `Ãšltimas 24h: ${s.last24h ?? 0}`;

      // Intent bars
      const actions = s.byAction || {};
      const relevantKeys = Object.keys(actions)
        .filter(k => !['prompt-received','response-sent','intent-parsed','api-server-started','web-server-started','error'].includes(k))
        .sort((a,b) => actions[b] - actions[a])
        .slice(0, 7);

      if (relevantKeys.length === 0) {
        // Fall back to showing top actions
        const topKeys = Object.keys(actions).sort((a,b) => actions[b] - actions[a]).slice(0, 7);
        renderIntentBars(topKeys, actions);
      } else {
        renderIntentBars(relevantKeys, actions);
      }
    }

    function renderIntentBars(keys, actions) {
      const container = document.getElementById('intentBars');
      if (keys.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:20px 0;text-align:center;">Sem dados ainda</div>';
        return;
      }
      const maxVal = actions[keys[0]] || 1;
      container.innerHTML = keys.map((k, i) => {
        const pct = Math.max(5, (actions[k] / maxVal) * 100);
        return `<div class="intent-bar">
          <div class="intent-label"><span>${fmtAction(k)}</span><span>${actions[k]}</span></div>
          <div class="intent-track"><div class="intent-fill c${(i % 7) + 1}" style="width:${pct}%"></div></div>
        </div>`;
      }).join('');
    }

    function updateLogs(logs) {
      const container = document.getElementById('logContainer');
      if (!logs || logs.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:20px 0;text-align:center;">Sem logs recentes</div>';
        return;
      }
      container.innerHTML = logs.slice(0, 50).map(l => {
        const time = new Date(l.timestamp).toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const date = new Date(l.timestamp).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit' });
        const actionClass = (l.action || '').replace(/[^a-zA-Z-]/g, '');
        const details = l.details ? fmtDetails(l.details) : '';
        return `<div class="log-entry">
          <span class="log-time">${date} ${time}</span>
          <span class="log-action ${actionClass}">${fmtAction(l.action)}</span>
          <span class="log-details" title="${escHTML(details)}">${details}</span>
          <span class="log-user">${l.userId || 'â€”'}</span>
        </div>`;
      }).join('');
    }

    function updateChart(stats) {
      if (!activityChart) return;
      const now = new Date().toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const count = stats?.last24h || 0;

      chartData.labels.push(now);
      chartData.data.push(count);

      // Keep last 30 points
      if (chartData.labels.length > 30) {
        chartData.labels.shift();
        chartData.data.shift();
      }

      activityChart.data.labels = chartData.labels;
      activityChart.data.datasets[0].data = chartData.data;
      activityChart.update('none');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function fetchJSON(path) {
      const res = await fetch(API_BASE + path);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function fmtUptime(sec) {
      if (sec < 60) return `${sec}s`;
      if (sec < 3600) return `${Math.floor(sec/60)}m ${sec%60}s`;
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      return `${h}h ${m}m`;
    }

    function fmtAction(action) {
      return (action || '').replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function fmtDetails(d) {
      if (!d || typeof d !== 'object') return String(d || '');
      const parts = [];
      if (d.prompt) parts.push(`"${d.prompt}"`);
      if (d.intent) parts.push(`intent: ${d.intent}`);
      if (d.method) parts.push(`(${d.method})`);
      if (d.elapsed) parts.push(`${d.elapsed}ms`);
      if (d.steps) parts.push(`${d.steps} passos`);
      if (d.completed) parts.push(`${d.completed} OK`);
      if (d.port) parts.push(`porta ${d.port}`);
      if (d.message) parts.push(d.message);
      if (d.source) parts.push(`via ${d.source}`);
      if (parts.length === 0) return JSON.stringify(d).substring(0, 80);
      return parts.join(' Â· ');
    }

    function escHTML(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
  </script>
</body>
</html>
